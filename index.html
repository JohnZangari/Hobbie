<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Wheels Database</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: all 0.3s ease-in-out;
        }
        .car-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-4xl">
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Hot Wheels Collection</h1>
            <p class="text-lg text-gray-600">Your personal database for die-cast cars.</p>
        </header>

        <!-- User Information & Controls -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <div class="flex-grow">
                <p id="user-info" class="text-sm font-medium text-gray-500 truncate">
                    User ID: <span id="user-id">Loading...</span>
                </p>
                <div id="status-message" class="text-sm mt-1"></div>
            </div>
            
            <div class="flex gap-4 w-full md:w-auto">
                <input type="text" id="search-input" placeholder="Search cars..." 
                       class="flex-grow md:flex-grow-0 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="add-car-btn" 
                        class="bg-blue-600 text-white rounded-full px-6 py-2 shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    Add Car
                </button>
            </div>
        </div>

        <!-- Car List Section -->
        <div id="car-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Car cards will be rendered here dynamically -->
        </div>

        <!-- No Cars Message -->
        <div id="no-cars-message" class="text-center text-gray-500 text-lg mt-8 hidden">
            <p>No cars found. Add your first Hot Wheels!</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="flex justify-center items-center mt-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
        </div>
    </div>

    <!-- Modal for Add/Edit Form -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 id="form-title" class="text-2xl font-bold mb-6 text-center">Add New Car</h2>
            <form id="car-form" class="space-y-4">
                <input type="hidden" id="car-id">
                
                <!-- Image input and preview -->
                <div>
                    <label for="car-image" class="block text-sm font-medium text-gray-700">Car Photo</label>
                    <div class="mt-1 flex justify-center items-center h-48 bg-gray-100 rounded-md border-2 border-dashed border-gray-300 cursor-pointer">
                        <img id="image-preview" src="" alt="Image Preview" class="max-h-full max-w-full object-contain rounded-md" style="display: none;">
                        <span id="image-placeholder" class="text-gray-400">Click to upload image</span>
                    </div>
                    <input type="file" id="car-image" accept="image/*" class="sr-only">
                </div>

                <!-- Gemini API buttons -->
                <div class="flex flex-col sm:flex-row gap-2">
                    <button type="button" id="autofill-btn" class="flex-grow bg-emerald-500 text-white rounded-full px-6 py-2 shadow-lg hover:bg-emerald-600 transition duration-300">
                        ✨ Auto-fill Car Details ✨
                    </button>
                </div>
                
                <!-- Regular form fields -->
                <div>
                    <label for="car-make" class="block text-sm font-medium text-gray-700">Make</label>
                    <input type="text" id="car-make" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="car-model" class="block text-sm font-medium text-gray-700">Model</label>
                    <input type="text" id="car-model" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="car-year" class="block text-sm font-medium text-gray-700">Year</label>
                    <input type="number" id="car-year" min="1960" max="2030" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="car-series" class="block text-sm font-medium text-gray-700">Series</label>
                    <input type="text" id="car-series" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <label for="car-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <button type="button" id="generate-notes-btn" class="text-xs text-blue-500 hover:text-blue-700 transition">
                            ✨ Generate Notes
                        </button>
                    </div>
                    <textarea id="car-notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="bg-blue-600 text-white rounded-full px-6 py-2 shadow-lg hover:bg-blue-700 transition duration-300">
                        Save Car
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace the placeholder values below with your own Firebase project configuration.
        // You can find this in your Firebase project settings.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Log all Firebase debug messages to the console
        setLogLevel('Debug');

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        // For a simple, single-user app, you can use a fixed string for the app ID.
        // For a production app, you would get this from your environment.
        const appId = "my-hot-wheels-app";
        const carCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/hot-wheels-cars`;
        const apiKey = ""; // API key is handled by the environment

        // UI elements
        const carList = document.getElementById('car-list');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noCarsMessage = document.getElementById('no-cars-message');
        const searchInput = document.getElementById('search-input');
        const addCarBtn = document.getElementById('add-car-btn');
        const formModal = document.getElementById('form-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const carForm = document.getElementById('car-form');
        const formTitle = document.getElementById('form-title');
        const carIdInput = document.getElementById('car-id');
        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id');
        const imageInput = document.getElementById('car-image');
        const imagePreview = document.getElementById('image-preview');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const imageDropzoneContainer = document.querySelector('.h-48.bg-gray-100');
        const autofillBtn = document.getElementById('autofill-btn');
        const generateNotesBtn = document.getElementById('generate-notes-btn');

        // State variables
        let cars = [];

        // Function to show a temporary message
        const showStatus = (message, isError = false) => {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'text-sm mt-1 text-red-600' 
                : 'text-sm mt-1 text-green-600';
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'text-sm mt-1';
            }, 3000);
        };

        // Function to render car data to the UI
        const renderCars = (carData) => {
            carList.innerHTML = '';
            if (carData.length === 0) {
                noCarsMessage.classList.remove('hidden');
            } else {
                noCarsMessage.classList.add('hidden');
                carData.forEach(car => {
                    const card = document.createElement('div');
                    card.className = 'car-card bg-white p-6 rounded-xl shadow-lg flex flex-col justify-between';
                    
                    const carImage = car.image 
                        ? `<img src="${car.image}" alt="Photo of ${car.make} ${car.model}" class="w-full h-48 object-cover rounded-lg mb-4">`
                        : `<div class="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center mb-4"><span class="text-gray-400">No Image</span></div>`;

                    card.innerHTML = `
                        <div>
                            ${carImage}
                            <h3 class="text-xl font-bold text-gray-900 truncate">${car.make} ${car.model}</h3>
                            <p class="text-gray-500 text-sm mt-1">${car.year} • ${car.series || 'N/A'}</p>
                            <p class="text-gray-700 mt-4">${car.notes || 'No notes.'}</p>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-4">
                            <button data-id="${car.id}" class="edit-btn text-blue-600 hover:text-blue-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-7.586 7.586l-2.828 2.828-.793.793 2.828 2.828.793-.793 2.828-2.828-2.828-2.828zM15 13l-1.5 1.5L12 11.5l1.5-1.5z" />
                                </svg>
                            </button>
                            <button data-id="${car.id}" class="delete-btn text-red-600 hover:text-red-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    carList.appendChild(card);
                });
            }
        };

        // Filter cars based on search input
        const filterCars = (query) => {
            const lowerCaseQuery = query.toLowerCase();
            const filteredCars = cars.filter(car => 
                car.make.toLowerCase().includes(lowerCaseQuery) ||
                car.model.toLowerCase().includes(lowerCaseQuery) ||
                (car.series && car.series.toLowerCase().includes(lowerCaseQuery))
            );
            renderCars(filteredCars);
        };
        
        // Event listener for search input
        searchInput.addEventListener('input', (e) => {
            filterCars(e.target.value);
        });

        // Function to open the form modal
        const openModal = () => {
            formModal.classList.remove('hidden');
        };

        // Function to close the form modal and reset the form
        const closeModal = () => {
            formModal.classList.add('hidden');
            carForm.reset();
            carIdInput.value = '';
            formTitle.textContent = 'Add New Car';
            // Reset image preview
            imagePreview.style.display = 'none';
            imagePlaceholder.style.display = 'block';
            imagePreview.src = '';
        };

        // Event listener for "Add Car" button
        addCarBtn.addEventListener('click', () => {
            openModal();
            carForm.reset();
            carIdInput.value = '';
            formTitle.textContent = 'Add New Car';
        });

        // Event listener for close modal button
        closeModalBtn.addEventListener('click', closeModal);

        // Event listener for image input change
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                imagePlaceholder.style.display = 'block';
                imagePreview.src = '';
            }
        });

        // Click the hidden file input when the dropzone is clicked
        imageDropzoneContainer.addEventListener('click', () => {
            imageInput.click();
        });

        // Handle autofill with Gemini API
        autofillBtn.addEventListener('click', async () => {
            if (!imagePreview.src || imagePreview.src.length === 0) {
                showStatus('Please upload an image first.', true);
                return;
            }

            autofillBtn.textContent = 'Analyzing...';
            autofillBtn.disabled = true;

            try {
                const base64ImageData = imagePreview.src.split(',')[1];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: "Identify the Hot Wheels make, model, and year from this image. Respond with only a JSON object containing the fields: 'make', 'model', and 'year'. Example: {'make': 'Ford', 'model': 'Mustang', 'year': '1968'}" },
                            { inlineData: { mimeType: "image/png", data: base64ImageData } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json"
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);
                    document.getElementById('car-make').value = parsedData.make || '';
                    document.getElementById('car-model').value = parsedData.model || '';
                    document.getElementById('car-year').value = parsedData.year || '';
                    showStatus('Details auto-filled!');
                } else {
                    showStatus('Could not identify car details. Please try another image.', true);
                }
            } catch (error) {
                console.error("Error during auto-fill: ", error);
                showStatus('Error auto-filling details. Check the console.', true);
            } finally {
                autofillBtn.textContent = '✨ Auto-fill Car Details ✨';
                autofillBtn.disabled = false;
            }
        });

        // Handle notes generation with Gemini API
        generateNotesBtn.addEventListener('click', async () => {
            const make = document.getElementById('car-make').value;
            const model = document.getElementById('car-model').value;
            const year = document.getElementById('car-year').value;

            if (!make && !model && !year) {
                showStatus('Please fill in car details first.', true);
                return;
            }

            generateNotesBtn.textContent = 'Generating...';
            generateNotesBtn.disabled = true;

            try {
                const userPrompt = `Write a fun, creative note for a Hot Wheels car. The car is a ${year} ${make} ${model}. Mention a fun fact or a unique feature. Keep it under 50 words.`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    document.getElementById('car-notes').value = generatedText;
                    showStatus('Notes generated!');
                } else {
                    showStatus('Could not generate notes. Please try again.', true);
                }

            } catch (error) {
                console.error("Error generating notes: ", error);
                showStatus('Error generating notes. Check the console.', true);
            } finally {
                generateNotesBtn.textContent = '✨ Generate Notes';
                generateNotesBtn.disabled = false;
            }
        });


        // Handle form submission for adding or editing a car
        carForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const carId = carIdInput.value;
            
            // Get image data from the preview source
            const carImage = imagePreview.src.startsWith('data:') ? imagePreview.src : null;

            const carData = {
                make: document.getElementById('car-make').value.trim(),
                model: document.getElementById('car-model').value.trim(),
                year: parseInt(document.getElementById('car-year').value, 10),
                series: document.getElementById('car-series').value.trim(),
                notes: document.getElementById('car-notes').value.trim(),
                image: carImage // Add image data to the document
            };

            if (!userId) {
                showStatus('User not authenticated. Cannot save data.', true);
                return;
            }

            try {
                if (carId) {
                    // Update existing car
                    const carDocRef = doc(db, carCollectionPath(userId), carId);
                    await updateDoc(carDocRef, carData);
                    showStatus('Car updated successfully!');
                } else {
                    // Add new car
                    const carColRef = collection(db, carCollectionPath(userId));
                    await addDoc(carColRef, carData);
                    showStatus('Car added successfully!');
                }
                closeModal();
            } catch (error) {
                console.error("Error saving car: ", error);
                showStatus('Error saving car. Please try again.', true);
            }
        });

        // Handle edit and delete button clicks using event delegation
        carList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const carId = target.dataset.id;
            if (!userId) {
                showStatus('User not authenticated. Cannot perform action.', true);
                return;
            }

            if (target.classList.contains('edit-btn')) {
                // Find the car in the local array and pre-fill the form
                const carToEdit = cars.find(c => c.id === carId);
                if (carToEdit) {
                    carIdInput.value = carToEdit.id;
                    document.getElementById('car-make').value = carToEdit.make;
                    document.getElementById('car-model').value = carToEdit.model;
                    document.getElementById('car-year').value = carToEdit.year;
                    document.getElementById('car-series').value = carToEdit.series;
                    document.getElementById('car-notes').value = carToEdit.notes;
                    formTitle.textContent = 'Edit Car';
                    
                    // Display image if it exists
                    if (carToEdit.image) {
                        imagePreview.src = carToEdit.image;
                        imagePreview.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                    } else {
                        imagePreview.src = '';
                        imagePreview.style.display = 'none';
                        imagePlaceholder.style.display = 'block';
                    }

                    openModal();
                }
            } else if (target.classList.contains('delete-btn')) {
                // Show a custom confirmation dialog
                const confirmationModal = document.createElement('div');
                confirmationModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50';
                confirmationModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                        <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                        <p class="text-gray-700 mb-6">Are you sure you want to delete this car?</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 rounded-full px-6 py-2 hover:bg-gray-400 transition">Cancel</button>
                            <button id="confirm-delete-btn" class="bg-red-600 text-white rounded-full px-6 py-2 hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationModal);

                document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                    confirmationModal.remove();
                });

                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    confirmationModal.remove();
                    try {
                        const carDocRef = doc(db, carCollectionPath(userId), carId);
                        await deleteDoc(carDocRef);
                        showStatus('Car deleted successfully!');
                    } catch (error) {
                        console.error("Error deleting car: ", error);
                        showStatus('Error deleting car. Please try again.', true);
                    }
                });
            }
        });

        // Firebase Auth State Listener
        // This is crucial for handling user authentication and setting up the Firestore listener.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                console.log("User authenticated with UID:", userId);
                
                // Get a reference to the 'hot-wheels-cars' collection for the current user
                const carsRef = collection(db, carCollectionPath(userId));
                
                // Set up real-time listener with onSnapshot
                // This will fetch the data once and then listen for all future changes.
                onSnapshot(carsRef, (snapshot) => {
                    loadingSpinner.classList.add('hidden');
                    cars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterCars(searchInput.value); // Re-filter and re-render the list
                    console.log("Real-time data received. Total cars:", cars.length);
                }, (error) => {
                    console.error("Error getting real-time data: ", error);
                    loadingSpinner.classList.add('hidden');
                    showStatus('Error fetching data. Please check the console.', true);
                });
            } else {
                // If no user is signed in, sign in anonymously.
                // NOTE: The previous version used a custom token, which is only available in this environment.
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                } catch (error) {
                    console.error("Authentication failed: ", error);
                    loadingSpinner.classList.add('hidden');
                    userIdDisplay.textContent = 'Auth Failed';
                    showStatus('Authentication failed. Please check the console.', true);
                }
            }
        });
    </script>
</body>
</html>
